on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Install Expect (for password automation)
      - name: Install Expect
        run: sudo apt-get install -y expect

      # Deploy using SSH and Password
      - name: Deploy Application
        run: |
          expect << EOF
          spawn ssh -o StrictHostKeyChecking=no root@${{ secrets.SSH_HOST }}
          expect "password:"
          send "${{ secrets.SSH_PASSWORD }}\r"
          expect "# "

          send "cd .. && cd /var/www/html && git config --system --add safe.directory /var/www/html && git stash && git pull https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com//parzzzival8080/kinecoin-web.git main  && npm install && npm run build \r"
          expect "# "

          # Now write the .htaccess using heredoc
          send "cat <<EOF > dist/.htaccess\r"
          send "<IfModule mod_negotiation.c>\r"
          send "  Options -MultiViews\r"
          send "</IfModule>\r"
          send "<IfModule mod_rewrite.c>\r"
          send "  RewriteEngine On\r"
          send "  RewriteBase /\r"
          send "  RewriteRule ^index\\.html$ - \\[L\\]\r"
          send "  RewriteCond %{REQUEST_FILENAME} !-f\r"
          send "  RewriteCond %{REQUEST_FILENAME} !-d\r"
          send "  RewriteRule . /index.html \\[L\\]\r"
          send "</IfModule>\r"
          send "EOF\r"
          expect "# "

          send "exit\r"
          expect eof
          EOF
