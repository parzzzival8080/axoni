on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Install Expect (for password automation)
      - name: Install Expect
        run: sudo apt-get install -y expect

      # Deploy using SSH and Password
      - name: Deploy Application
        run: |
          expect << EOF
          spawn ssh -o StrictHostKeyChecking=no root@${{ secrets.SSH_HOST }}
          expect "password:"
          send "${{ secrets.SSH_PASSWORD }}\r"
          expect "# "
          send "cd /var/www/html && git config --system --add safe.directory /var/www/html && git stash && git pull https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_TOKEN }}@github.com//parzzzival8080/kinecoin-web.git ${{ env.GIT_BRANCH }} && npm install \r"
          expect "# "
          send "npm run build \r"
          expect -re "âœ“ built in \\[0-9\\]+ms"
          send "cat > dist/.htaccess <<'EOF'\r"
          send "<IfModule mod_negotiation.c>\r"
          send "  Options -MultiViews\r"
          send "</IfModule>\r"
          send "<IfModule mod_rewrite.c>\r"
          send "  RewriteEngine On\r"
          send "  RewriteBase /\r"
          send "  RewriteRule ^index.html$ - \\[L\\]\r"
          send "  RewriteCond %{REQUEST_FILENAME} !-f\r"
          send "  RewriteCond %{REQUEST_FILENAME} !-d\r"
          send "  RewriteRule . /index.html \\[L\\]\r"
          send "</IfModule>\r"
          send "EOF\r"

          expect "# "

          # Optional: verify file
          send "ls -l dist/.htaccess\r"
          expect "# "          expect "# "
                    send "exit\r"
                    expect eof
                    EOF
